---
title: "DRAFT_secondtrailopening"
output: html_document
---

```{r}
library(Maria)
library(readr)
library(dplyr)
library(tibble)
library(tidyr)
library(ggplot2)
library(reshape)
library(sf)
library(raster)
```

```{r}
otherloggingparameters = loggingparameters()
DEMParacou <- raster(paste0(Sys.getenv('DATAPATH'),"/GIS/Paracou/Topo_P6_PARACOU.tif"))
Plots <- st_as_sf(rgdal::readOGR(paste0(Sys.getenv('DATAPATH'),"/GIS/Paracou/Plot_P6_PARACOU.shp")))
MainTrails <- st_as_sf(as(rgdal::readOGR(paste0(Sys.getenv('DATAPATH'),"/GIS/Paracou/maintrail_P6_PARACOU.shp")),"SpatialLines" ))
PlotSlope <- raster::terrain(raster::mask( x = DEMParacou,mask = Plots))
res(DEMParacou)
res(PlotSlope)
load(paste0(Sys.getenv('DATAPATH'),"/treeselectionoutputs.Rdata"))
inventory <- treeselectionoutputs$inventory


HarvestableTreesPoints <- inventory %>% filter(LoggingStatus == "harvestable" | LoggingStatus == "harvestableUp" | LoggingStatus == "harvestable2nd")
if (dim(HarvestableTreesPoints)[1] != 0) {
coordinates(HarvestableTreesPoints) <- ~ Xutm + Yutm
proj4string(HarvestableTreesPoints) <- raster::crs(DEMParacou)
HarvestableTreesPoints <- st_as_sf(as(HarvestableTreesPoints,"SpatialPoints"))
}

SelectedTreesPoints <- inventory %>% filter(Selected == "1")
if (dim(SelectedTreesPoints)[1] != 0) {
coordinates(SelectedTreesPoints) <- ~ Xutm + Yutm
proj4string(SelectedTreesPoints) <- raster::crs(DEMParacou)
SelectedTreesPoints <- st_as_sf(as(SelectedTreesPoints,"SpatialPoints"))
}

FutureTreesPoints <- inventory %>% filter(LoggingStatus == "future")
if (dim(FutureTreesPoints)[1] != 0) {
coordinates(FutureTreesPoints) <- ~ Xutm + Yutm
proj4string(FutureTreesPoints) <- raster::crs(DEMParacou)
FutureTreesPoints <- st_as_sf(as(FutureTreesPoints,"SpatialPoints"))
}

ReserveTreesPoints <- inventory %>% filter(LoggingStatus == "reserve")
if (dim(ReserveTreesPoints)[1] != 0) {
coordinates(ReserveTreesPoints) <- ~ Xutm + Yutm
proj4string(ReserveTreesPoints) <- raster::crs(DEMParacou)
ReserveTreesPoints <- st_as_sf(as(ReserveTreesPoints,"SpatialPoints"))
}

HollowTreesPoints  <- inventory %>% filter(ProbedHollow == "1")
if (dim(HollowTreesPoints)[1] != 0) {
  coordinates(HollowTreesPoints) <- ~ Xutm + Yutm
  proj4string(HollowTreesPoints) <- raster::crs(DEMParacou)
  HollowTreesPoints  <- st_as_sf(as(HollowTreesPoints ,"SpatialPoints"))
}


# EnergywoodTreesPoints  <- inventory %>% filter(DeathCause  == "fuelwood")
# if (dim(EnergywoodTreesPoints)[1] != 0) {
# coordinates(EnergywoodTreesPoints) <- ~ Xutm + Yutm
# proj4string(EnergywoodTreesPoints) <- raster::crs(DEMParacou)
# EnergywoodTreesPoints <- st_as_sf(as(EnergywoodTreesPoints,"SpatialPoints"))
# }

rm(treeselectionoutputs)

ggplot() + geom_sf(data = MainTrails) + geom_sf(data = HarvestableTreesPoints, aes(color = "Harvestable")) + 
  geom_sf(data = SelectedTreesPoints, aes(color = "Selected")) + geom_sf(data = FutureTreesPoints, aes(color = "Futures")) + geom_sf(data = ReserveTreesPoints, aes(color = "Reserves"))
```

```{r}
require(raster)
require(tidyverse)
require(sf)
library(Rsagacmd)

Soil_paracou_path <- paste0(Sys.getenv('DATAPATH'), "/GIS/Paracou/")
SAGA <- saga_gis()
DEM <- SAGA$ta_preprocessor$fill_sinks_xxl_wang_liu(elev = paste0(Soil_paracou_path,"Dem.sgrd"),minslope = 0.01,.verbose = T)

Channels <- SAGA$ta_channels$channel_network(elevation = DEM,init_grid = DEM,init_method = "2",init_value = 10)
HCrique <- SAGA$ta_channels$vertical_distance_to_channel_network(elevation = DEM,channels = Channels$chnlntwrk)

HarvestableAreaDefinition <- function(Plot, DEM, HCrique) {
  
  
  # On commence par decouper par l'emprise du plot
  PlotTopo <- raster::mask(x = DEM,
                           mask = Plot) # découpage de la topo par l'emprise du plot
  HCriquePlot <- raster::mask(x = HCrique,
                              mask = Plot) # la même chose pour la hauteur à la crique

  # Calcul de la pente
  PlotSlope <- raster::terrain(PlotTopo,
                               opt = "slope",
                               units = 'radians',
                               neigbors = 8)
  # RastersToPoints

  PlotSlopePoint <-
    dplyr::as_tibble(raster::rasterToPoints(PlotSlope))

  HCriquePlotPoint <-
    dplyr::as_tibble(raster::rasterToPoints(HCriquePlot))

  # left join par x et y
  PlotTib <-
    dplyr::left_join(PlotSlopePoint, HCriquePlotPoint, by = c('x', 'y'))

  PlotTib %>% dplyr::rename("HauteurCrique" = names(PlotTib[4]))  %>%
    mutate(Exploit = if_else(
      condition = HauteurCrique > 2 &
        slope <= .264, # on est en radians pour la pente, donc .264 radians = 27% de pente
      true = 1,
      false = 0
    )) -> PlotSlopeHCrique

  # on a pu determiner les zones exploitables ou non
  # maintenant on transforme ça en polygones, PlotSlopeHCrique pourrait etre reutilise pour la pente

  # on retransforme en raster
  RasterExploit <-
    raster::rasterFromXYZ(PlotSlopeHCrique, crs = 32622) # set crs to WGS84 UTM 22N

  # raster en polygone
  PolygoneExploit <-
    raster::rasterToPolygons(x = RasterExploit$Exploit,
                             n = 16,
                             dissolve = TRUE)

  ## On quitte le monde merveilleux du package raster pour passer a celui de sf

  sf_PolygoneExploit <- sf::st_as_sf(PolygoneExploit)

  ## On transforme nos deux gros polygones (Exploit=1 et Exploit=0 en pleins de petits, par ce qui s'appelait disaggregate dans le package sp)

  ExploitPolygones <-
    sf::st_cast(x = sf_PolygoneExploit, to = "POLYGON") # on a maintenant pleins de polygones, dont pleins de petits isolés

  return(ExploitPolygones)

}

UP <- HarvestableAreaDefinition(Plot = Plots,DEM = DEMParacou,HCrique = 3)
```



```{r}

# secondtrailsopening <- function(inventory,
#                                 DEM = DEMParacou,
#                                 plotslope =  PlotSlope,
#                                 plots = Plots,
#                                 prospectionunit = ProspectionUnit,
#                                 maintrails = MainTrails,
#                                 selectedtreespoints = SelectedTreesPoints,
#                                 hollowtreespoints = HollowTreesPoints,
#                                 avenirtreespoints = AvenirTreesPoint,
#                                 reservetreespoints = ReserveTreesPoints,
#                                 deadtreespoints = DeadTreesPoints,
#                                 otherlogginparameters = logginparameters()) {

  # Arguments check

  if(!inherits(inventory, "data.frame"))
    stop("The 'inventory' arguments of the 'secondtrailsopening' function must be data.frame")

  if(!inherits(Plots, "sf"))
    stop("The 'plots' arguments of the 'secondtrailsopening' function must be sf polygon")

  if(!any(unlist(lapply(list(DEMParacou, PlotSlope), inherits, "RasterLayer"))))
    stop("The 'DEM' and 'plotslope' arguments of the 'secondtrailsopening' function must be raster")

  # Redefinition of the parameters according to the chosen scenario
  scenariosparameters <- scenariosparameters(objective = objective, type = type, fuel = fuel,
                                             diversification = diversification)

  objective <- scenariosparameters$objective
  fuel <- scenariosparameters$fuel
  diversification <- scenariosparameters$diversification
  
  if (type == "RIL1" | type == "RIL2broken" | (type == "manual" & winching == "0")) {
    
  } else {
    
  }
  if (type == "RIL2" | (type == "manual" & winching == "1")) {
    
  }
  
  if (type == "RIL3" | type == "RIL3fuel" | type == "RIL3fuelhollow" | (type == "manual" & winching == "2")) {
    
  }


```


